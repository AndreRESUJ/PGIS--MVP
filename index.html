<script>
  // === Config ===
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwXVjxxP2wWIEsolYSBswjXkKuI4oIpujXx9kzwdgNcer_UIsSHF7Tu7ASlR2tdLThPbQ/exec";
  const SUBMIT_TOKEN   = "pgis_token_7c28";
  const EXPORT_PASSWORD = "Hydro2025Secure!";

  // === Globals (init after consent) ===
  let map, drawn, drawControl;
  const submissions = [];

  // --- UI helpers ---
  const toast = (msg) => {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    setTimeout(() => (t.style.display = 'none'), 3000);
  };
  const isIOS = () =>
    /iPad|iPhone|iPod/.test(navigator.userAgent) ||
    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

  // --- Local autosave ---
  function saveLocal() {
    try { localStorage.setItem('pgis_submissions', JSON.stringify(submissions)); } catch {}
  }
  function restoreLocal() {
    try {
      const saved = JSON.parse(localStorage.getItem('pgis_submissions') || '[]');
      if (saved.length && drawn) {
        saved.forEach(f => {
          const [lng, lat] = f.geometry.coordinates;
          L.marker([lat, lng]).addTo(drawn);
        });
        submissions.push(...saved);
        toast(`Restored ${saved.length} saved point(s) on this device.`);
      }
    } catch {}
  }

  // --- Popup form ---
  function popupFormHTML(d = {}) {
    const defaults = { status:'Abandoned', access:'Unknown', risk:'Unknown', notes:'' };
    const v = Object.assign(defaults, d);
    return `
      <div style="min-width:220px">
        <label style="display:block;font-size:12px;color:#9fb0d9;margin:4px 0">Building status</label>
        <select id="f_status">
          <option ${v.status==='Abandoned'?'selected':''}>Abandoned</option>
          <option ${v.status==='Vacant'?'selected':''}>Vacant</option>
          <option ${v.status==='Underutilised'?'selected':''}>Underutilised</option>
          <option ${v.status==='Other'?'selected':''}>Other</option>
        </select>
        <label style="display:block;font-size:12px;color:#9fb0d9;margin:6px 0 4px">Access</label>
        <select id="f_access">
          <option ${v.access==='Unknown'?'selected':''}>Unknown</option>
          <option ${v.access==='Open'?'selected':''}>Open</option>
          <option ${v.access==='Fenced'?'selected':''}>Fenced</option>
          <option ${v.access==='Guarded'?'selected':''}>Guarded</option>
        </select>
        <label style="display:block;font-size:12px;color:#9fb0d9;margin:6px 0 4px">Apparent risk</label>
        <select id="f_risk">
          <option ${v.risk==='Unknown'?'selected':''}>Unknown</option>
          <option ${v.risk==='Low'?'selected':''}>Low</option>
          <option ${v.risk==='Medium'?'selected':''}>Medium</option>
          <option ${v.risk==='High'?'selected':''}>High</option>
        </select>
        <label style="display:block;font-size:12px;color:#9fb0d9;margin:6px 0 4px">Notes</label>
        <textarea id="f_notes" placeholder="Add any details...">${v.notes||''}</textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="savePoint" class="btn" style="flex:1">Save</button>
          <button id="cancelPoint" class="btn secondary" style="flex:1">Cancel</button>
        </div>
      </div>`;
  }

  // --- Initialize Leaflet AFTER consent ---
  function initMapOnce() {
    if (map) return;
    map = L.map('map', { zoomControl: true });
    const start = L.latLng(-25.746, 28.190); // Tshwane CBD approx
    map.setView(start, 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    drawn = new L.FeatureGroup();
    map.addLayer(drawn);

    drawControl = new L.Control.Draw({
      draw: { polygon:false, polyline:false, rectangle:false, circle:false, circlemarker:false, marker:{ title:'Add abandoned building point' } },
      edit: { featureGroup: drawn }
    });
    map.addControl(drawControl);

    // Buttons (now the elements are visible)
    document.getElementById('addPoint').addEventListener('click', () => {
      new L.Draw.Marker(map, drawControl.options.draw.marker).enable();
      toast('Click the map to place a point…');
    });
    document.getElementById('locate').addEventListener('click', () => {
      map.locate({ setView:true, maxZoom:17 });
      setTimeout(() => map.invalidateSize(true), 50);
    });

    // Drawing handler
    map.on(L.Draw.Event.CREATED, (e) => {
      const layer = e.layer;
      const latlng = layer.getLatLng();
      drawn.addLayer(layer);
      layer.bindPopup(popupFormHTML());
      setTimeout(() => layer.openPopup(), 0);

      layer.on('popupopen', () => {
        const saveBtn = document.getElementById('savePoint');
        const cancelBtn = document.getElementById('cancelPoint');

        if (saveBtn) saveBtn.onclick = () => {
          const feature = {
            type: 'Feature',
            geometry: { type:'Point', coordinates:[latlng.lng, latlng.lat] },
            properties: {
              participant: document.getElementById('pname').value.trim(),
              ward:        document.getElementById('ward').value.trim(),
              contact:     document.getElementById('contact').value.trim(),
              sessionNote: document.getElementById('sessionNote').value.trim(),
              status:      document.getElementById('f_status').value,
              access:      document.getElementById('f_access').value,
              risk:        document.getElementById('f_risk').value,
              notes:       document.getElementById('f_notes').value.trim(),
              created_at:  new Date().toISOString()
            }
          };
          submissions.push(feature);
          saveLocal();
          layer.closePopup();
          toast('Point saved.');
        };

        if (cancelBtn) cancelBtn.onclick = () => {
          drawn.removeLayer(layer);
          toast('Point discarded');
        };
      });
    });

    // Resize fixes + restore saved points
    window.addEventListener('resize', () => map.invalidateSize(true));
    setTimeout(() => map.invalidateSize(true), 50);
    restoreLocal();
  }

  // --- Consent flow ---
  function showApp() {
    document.getElementById('consentScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    initMapOnce();
  }
  window.addEventListener('DOMContentLoaded', () => {
    const startBtn = document.getElementById('startBtn');
    startBtn?.addEventListener('click', () => {
      if (!document.getElementById('consentAgree').checked) {
        alert('Please check the consent box to continue.');
        return;
      }
      showApp();
    });
  });

  // --- Export (researcher only) ---
  document.getElementById('exportBtn').addEventListener('click', () => {
    const pwd = prompt('Enter researcher password to export:');
    if (pwd !== EXPORT_PASSWORD) { alert('Incorrect password. Export denied.'); return; }
    if (submissions.length === 0) { alert('No data to export.'); return; }

    const fc = { type:'FeatureCollection', features: submissions };
    const blob = new Blob([JSON.stringify(fc, null, 2)], { type:'application/geo+json' });
    const url  = URL.createObjectURL(blob);

    if (isIOS()) {
      window.open(url, '_blank');
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      alert('On iPhone/iPad, use the Share button in the new tab → "Save to Files" to keep the .geojson.');
    } else {
      const a = document.createElement('a');
      a.href = url;
      a.download = 'abandoned_buildings.geojson';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }
  });

  // --- Submit to Researcher (text/plain to avoid CORS preflight) ---
  async function submitToResearcher() {
    if (!navigator.onLine) { alert("You're offline. Please connect and try again."); return; }
    if (submissions.length === 0) { alert('No points to submit yet.'); return; }

    const payload = {
      token: SUBMIT_TOKEN,
      participant: document.getElementById('pname').value.trim(),
      ward:        document.getElementById('ward').value.trim(),
      contact:     document.getElementById('contact').value.trim(),
      sessionNote: document.getElementById('sessionNote').value.trim(),
      features:    submissions,
      userAgent:   navigator.userAgent || ''
    };

    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), 15000);

    try {
      const res = await fetch(GAS_WEBAPP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // avoids preflight
        body: JSON.stringify(payload),
        signal: ctrl.signal
      });
      clearTimeout(t);
      let data = {};
      try { data = await res.json(); } catch {}

      if (res.ok) {
        try { localStorage.removeItem('pgis_submissions'); } catch {}
        toast('Thank you! Your submission has been received and sent to the researcher.');
      } else {
        alert('Submission error: ' + (data.message || res.status + ' ' + res.statusText));
      }
    } catch (e) {
      if (e.name === 'AbortError') alert('Network timeout. Try again on a stable connection.');
      else { alert('Network error. Please try again when you have connectivity.'); console.error(e); }
    }
  }
  document.getElementById('submitBtn').addEventListener('click', submitToResearcher);

  // Safety: if app is already visible (e.g., hot reload), ensure map is inited
  window.addEventListener('load', () => {
    if (document.getElementById('app').style.display === 'block') initMapOnce();
  });
</script>

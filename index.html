<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PGIS: Abandoned Buildings Reporting ‚Äì Tshwane Region 3 (MVP)</title>
  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    :root{--bg:#0b1020;--panel:#111831;--card:#1a2342;--text:#e8edf8;--muted:#9fb0d9;--accent:#79b8ff}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}

    header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:12px}
    header h1{font-size:18px;margin:0;letter-spacing:.2px}
    header .badge{font-size:12px;padding:4px 8px;border:1px solid rgba(255,255,255,.15);border-radius:999px;color:var(--muted)}

    #consentScreen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);padding:20px}
    #consentBox{max-width:700px;background:var(--panel);padding:24px;border-radius:14px;border:1px solid rgba(255,255,255,.1)}
    #consentBox h2{margin-top:0}
    #consentBox p{font-size:14px;line-height:1.6;color:var(--text)}
    #consentBox .btn{margin-top:16px}

    #app{display:none}
    .wrap{display:grid;grid-template-columns:330px 1fr;min-height:calc(100vh - 58px)}
    aside{background:var(--panel);padding:16px 14px;overflow:auto}
    main{position:relative;min-height:calc(100vh - 58px)}
    #map{position:absolute;inset:0;height:100%;width:100%;min-height:420px}

    .card{background:var(--card);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:12px;margin-bottom:12px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;background:#101831;border:1px solid rgba(255,255,255,.12);border-radius:10px;color:var(--text)}
    textarea{min-height:70px}
    .row{display:flex;gap:8px}
    .row>*{flex:1}
    .btn{display:inline-block;background:var(--accent);color:#0b132b;border:none;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,.2);color:var(--text)}
    .btn.full{width:100%}
    .muted{color:var(--muted);font-size:12px}
    .hl{color:#b3d4ff}
    .legend{position:absolute;z-index:500;background:rgba(17,24,49,.9);padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);bottom:14px;left:14px;font-size:12px}
    .legend b{color:#cfe1ff}
    .toast{position:fixed;right:12px;bottom:12px;background:#142046;border:1px solid rgba(255,255,255,.18);padding:10px 12px;border-radius:10px;font-size:12px;display:none}

    @media (max-width: 820px) {
      .wrap { grid-template-columns: 1fr; }
      aside { padding: 10px 10px 4px; }
      main  { min-height: 60vh; }
      #map  { min-height: 60vh; }
      header h1 { font-size: 16px; }
      input, select, textarea, .btn { font-size: 16px; }
      .btn { padding: 12px 14px; border-radius: 12px; }
    }
    #exportBtn { margin-bottom: 12px; }
  </style>
</head>
<body>
  <!-- Consent Screen -->
  <div id="consentScreen">
    <div id="consentBox">
      <h2>Participant Information and Consent</h2>
      <p><b>Purpose of study:</b> Mapping abandoned/vacant/underutilised buildings in Tshwane to assess the feasibility of inner-city hydroponics for food security.</p>
      <p><b>Voluntary participation:</b> You may withdraw at any time. Provide only information you are comfortable sharing.</p>
      <p><b>Confidentiality:</b> Name/contact are optional. Data is anonymised in reporting.</p>
      <p><b>Data handling:</b> Submissions are transmitted to a secure Google service (Apps Script) controlled by the researcher and stored in a private spreadsheet.</p>
      <label><input type="checkbox" id="consentAgree"> I have read and consent to participate.</label><br>
      <button id="startBtn" class="btn">Proceed to Map</button>
    </div>
  </div>

  <!-- Main App -->
  <div id="app">
    <header>
      <h1>PGIS: Abandoned Buildings Reporter</h1>
      <span class="badge">Tshwane Region 3 ‚Ä¢ MVP</span>
    </header>
    <div class="wrap">
      <aside>
        <div class="card">
          <div class="pill">Participant</div>
          <label for="pname">Your name (or initials)</label>
          <input id="pname" placeholder="Optional" />
          <div class="row">
            <div>
              <label for="ward">Ward number</label>
              <input id="ward" type="number" min="1" placeholder="e.g., 58" />
            </div>
            <div>
              <label for="contact">Contact (optional)</label>
              <input id="contact" placeholder="email or phone" />
            </div>
          </div>
          <label for="sessionNote">General notes (optional)</label>
          <textarea id="sessionNote" placeholder="Any overall notes for this session"></textarea>
        </div>

        <div class="card">
          <div class="pill">Add a building</div>
          <ol class="muted">
            <li>Click <span class="hl">Add point</span>, then click the map to drop a pin on the building.</li>
            <li>Fill in the popup form (status, access, risk, notes) and save.</li>
            <li>Repeat for multiple buildings.</li>
          </ol>
          <div class="row">
            <button id="addPoint" class="btn">‚ûï Add point</button>
            <button id="locate" class="btn secondary">üìç Use my location</button>
          </div>
        </div>

        <div class="card">
          <div class="pill">Export / Submit</div>
          <p class="muted">Export requires researcher password. "Submit" sends your data securely to the researcher.</p>
          <button id="exportBtn" class="btn full">‚¨áÔ∏è Export Data (GeoJSON, researcher only)</button>
          <button id="submitBtn" class="btn full">üì® Submit to Researcher</button>
        </div>
      </aside>

      <main>
        <div id="map"></div>
        <div class="legend">‚Ü≥ <b>How to use:</b> Click <i>Add point</i> ‚Üí click map ‚Üí fill popup ‚Üí Save.</div>
        <div id="toast" class="toast"></div>
      </main>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script>
    const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwXVjxxP2wWIEsolYSBswjXkKuI4oIpujXx9kzwdgNcer_UIsSHF7Tu7ASlR2tdLThPbQ/exec";
    const SUBMIT_TOKEN   = "pgis_token_7c28";

    // --- Globals ---
    let map, drawn, drawControl;
    const submissions = [];

    // Toast helper
    const toast=(msg)=>{const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';setTimeout(()=>t.style.display='none',3000)}

    // Local autosave helpers
    function saveLocal(){ try{ localStorage.setItem("pgis_submissions", JSON.stringify(submissions)); }catch(_){} }
    function restoreLocal(){
      try{
        const saved = JSON.parse(localStorage.getItem("pgis_submissions") || "[]");
        if(saved.length && drawn){
          saved.forEach(f=>{ const [lng,lat]=f.geometry.coordinates; L.marker([lat,lng]).addTo(drawn); });
          submissions.push(...saved);
          toast(`Restored ${saved.length} saved point(s).`);
        }
      }catch(_){}
    }

    // Build popup UI
    function popupFormHTML(){
      return `
        <div style="min-width:220px">
          <label>Status</label>
          <select id="f_status"><option>Abandoned</option><option>Vacant</option><option>Underutilised</option><option>Other</option></select>
          <label>Access</label>
          <select id="f_access"><option>Unknown</option><option>Open</option><option>Fenced</option><option>Guarded</option></select>
          <label>Risk</label>
          <select id="f_risk"><option>Unknown</option><option>Low</option><option>Medium</option><option>High</option></select>
          <label>Notes</label>
          <textarea id="f_notes" placeholder="Add details..."></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="savePoint" class="btn" style="flex:1">Save</button>
            <button id="cancelPoint" class="btn secondary" style="flex:1">Cancel</button>
          </div>
        </div>`;
    }

    // Initialize map after consent
    function initMapOnce(){
      if(map) return;
      map = L.map('map').setView([-25.746, 28.190], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
      drawn = new L.FeatureGroup(); map.addLayer(drawn);
      drawControl = new L.Control.Draw({ draw:{polygon:false,polyline:false,rectangle:false,circle:false,circlemarker:false}, edit:{featureGroup:drawn} });
      map.addControl(drawControl);

      // Add point
      document.getElementById('addPoint').addEventListener('click',()=>{
        new L.Draw.Marker(map).enable(); toast('Click map to add a point');
      });

      // On draw
      map.on(L.Draw.Event.CREATED, function(e){
        const layer = e.layer; const latlng = layer.getLatLng();
        drawn.addLayer(layer); layer.bindPopup(popupFormHTML()); setTimeout(()=>layer.openPopup(),0);
        layer.on('popupopen', ()=>{
          document.getElementById('savePoint').onclick=()=>{
            const feature={type:'Feature',geometry:{type:'Point',coordinates:[latlng.lng,latlng.lat]},properties:{ward:document.getElementById('ward').value.trim(),status:document.getElementById('f_status').value,access:document.getElementById('f_access').value,risk:document.getElementById('f_risk').value,notes:document.getElementById('f_notes').value.trim()}};
            submissions.push(feature); saveLocal(); layer.closePopup(); toast('Point saved');
          };
          document.getElementById('cancelPoint').onclick=()=>{drawn.removeLayer(layer);toast('Discarded');};
        });
      });
      restoreLocal();
    }

    // Consent flow
    function showApp(){document.getElementById('consentScreen').style.display='none';document.getElementById('app').style.display='block';initMapOnce();}
    document.getElementById('startBtn').addEventListener('click',()=>{if(!document.getElementById('consentAgree').checked){alert('Please tick consent');return;}showApp();});

    // Export
    const EXPORT_PASSWORD="Hydro2025Secure!";
    document.getElementById('exportBtn').addEventListener('click',()=>{
      const pwd=prompt('Password?'); if(pwd!==EXPORT_PASSWORD){alert('Denied');return;}
      const fc={type:'FeatureCollection',features:submissions};
      const blob=new Blob([JSON.stringify(fc,null,2)],{type:'application/geo+json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download='data.geojson';a.click();URL.revokeObjectURL(url);
    });

    // Submit
    document.getElementById('submitBtn').addEventListener('click',async()=>{
      if(submissions.length===0){alert('No points');return;}
      const payload={token:SUBMIT_TOKEN,features:submissions};
      try{const res=await fetch(GAS_WEBAPP_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)});if(res.ok){localStorage.removeItem('pgis_submissions');toast('Thank you! Submitted.');}else alert('Error');}catch(e){alert('Network error');}
    });
  </script>
</body>
</html>
